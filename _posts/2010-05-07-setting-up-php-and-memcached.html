--- 
layout: post
title: Setting up PHP and Memcached
tags: 
- memcached
- php
status: trash
type: post
published: false
meta: 
  _edit_last: "1"
  _wp_trash_meta_status: draft
  _wp_trash_meta_time: "1314733851"
---
Last sprint my team spent time mostly on topics related to Memcached and PHP client configuration. While information is fresh, I will write some points that might make clearer picture for someone not so experienced with this topic. According to the target audience it is not technical in detail but rather focused on the concepts involved.

<a title="Memcached server page" href="http://memcached.org/">Memcached</a> is a free &amp; open source, high-performance, distributed memory object caching system. Usually memcached storage is used for keeping data which is expensive to produce over and over again on every request. Cached data is kept in distributed memory for fast serving. One of most common use cases is caching of a database response so db pool is relaxed from high load and waiting time for the db response is not blocking the request execution.

<!--more-->For making the memcached caching system work you need server that will keep your data in memory and client that will store and retreive data from the distributed memory.
<h3>Server</h3>
Memcached server is installed as a daemon on machines that you would like to use as a storage. More information about the <a title="Installing memcached server" href="http://code.google.com/p/memcached/wiki/NewInstallFromPackage">installation</a> and <a title="Configuring memcached" href="http://code.google.com/p/memcached/wiki/NewConfiguringServer">configuration</a> can be found on the memcached <a title="Memcached wiki" href="http://code.google.com/p/memcached/wiki/NewStart">wiki</a>. After start it will initialize amount of memory you configured it for and will start waiting for clients to put some data inside and start reading from it. For example
<blockquote>/usr/bin/memcached -l 127.0.0.1 -p 12121-m 64</blockquote>
would run instance on port 12121 with 64 MB of memory allocated for the storage. Fact that all the data is in memory means that after server is restarted all data is gone. There can be multiple daemons run on the same machine but this is not something that is usually done. If you would like to have multiple machines running daemons which are not symmetrical in the amount of memory they use it can be configured in client as setting more weight to servers with more memory.
<h3>Client</h3>
Client is used to make some use of the server daemons that are running on your machines. In PHP world there are two PECL packages named similarly . First is named <a title="PHP PECL Memcache extension" href="http://php.net/manual/en/book.memcache.php">Memcache</a> and is implemented fully as independent PHP extension. Second is <a title="PHP PECL Memcached extension" href="http://php.net/manual/en/book.memcached.php">Memcached</a> which is PHP extension implemented as a wrapper around C client library called <a title="Libmemcached site" href="http://libmemcached.org/">libmemcached</a>. At local.ch we use second one. It is more actively maintained and developed and libmemcached is library around which other languages seem to focus client developments as well with taking care of cross compatibility issues. Currently, PHP Memcached in version 1.0.2 is compatible for building against libmemcached 0.39, although there is newer version of the libmemcached out.

Generally, use case is the following. You have some data and want to store it in the cache for later use. You give the name to the data and in the form of key/value pair you save it to the server pool. Afterwards, you request the value stored in cache by the key. This raises the question about how client decides on which server it should store the key/value pair and how to know from which server to retrieve it without looking through all the servers, which would be highly inefficient. If you have one server then there is not much to think, but with massive installations and tens or even hundreds of memcached servers this becomes very important question.

Answer to these questions lies in the hashing algorithm used. By default Memcached client uses hashing algorithm based on the modulo division with the number of servers which are defined in the list of servers client knows about. This approach suffers from a problem of unstable configuration changes. When for example you want to add new server to the pool of servers then list of servers in your client changes, hashing function that relies on number of servers doesn't produce anymore same values and your mappings of keys on the servers are lost for most of the keys. You will numer of keys proportional to the number of servers, more you have, more you lose. In effect it is like you restarted most of your servers.

To conquer this problem PHP Memcached client exposes libmemcached option for using <a title="Consistent hashing wikipedia" href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a> algorithm when mapping keys. More details about algorithm can be found <a title="Consistent hashing explained" href="http://www.tomkleinpeter.com/2008/03/17/programmers-toolbox-part-3-consistent-hashing/">here</a>. In effect, when using this algorithm you can change list of servers that client knows about without affecting the whole server pool. Number of keys lost when configuration change is done is reversely proportional to the number of servers you have, more you have, less you lose.

There is lot of other <a title="PHP Memcached client options" href="http://www.php.net/manual/en/memcached.constants.php">options</a> which can be set for the PHP Memcached client. Some of them are related to the way client connects to the servers and are explained in text below.

Connection

- when is connection actually made

- blocking vs non-blocking
- persistent connection, configuration regarding host skipping and retry timeout, auto eject hosts

- add some code to the text
- make some words strong
- clean and publish
